{% extends 'base.html' %}
{% load static %}

{% block title %}Nearby Mechanics - Vehicle Breakdown Service{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .mechanic-list {
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
    }
    .mechanic-card {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .mechanic-card:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }
    .mechanic-card h5 {
        margin-bottom: 5px;
        color: var(--primary-color);
    }
    .mechanic-card p {
        margin-bottom: 3px;
        font-size: 0.9rem;
    }
    .mechanic-card .distance {
        font-weight: bold;
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
<h1 class="mb-4 text-center">Nearby Mechanics for Service Request</h1>
    <p class="text-center text-muted mb-4">Location: {{ service_request.location }}</p>

    <div class="row">
        <div class="col-md-8">
            <div class="input-group mb-3">
                <input type="text" id="place-search-input" class="form-control" placeholder="Search for nearby places (e.g., petrol bunk, towing service)">
                <button class="btn btn-primary" type="button" id="search-places-button">Search Places</button>
            </div>
            <div id="map"></div>
        </div>
        <div class="col-md-4">
            <h3>Available Mechanics</h3>
            <div class="mechanic-list">
                {% if nearby_mechanics %}
                    {% for mechanic_data in nearby_mechanics %}
                        <div class="mechanic-card" data-lat="{{ mechanic_data.mechanic.latitude }}" data-lng="{{ mechanic_data.mechanic.longitude }}" data-name="{{ mechanic_data.mechanic.user.get_full_name|default:mechanic_data.mechanic.user.username }}" data-specialization="{{ mechanic_data.mechanic.specialization }}" data-distance="{{ mechanic_data.distance }}">
                            <h5>{{ mechanic_data.mechanic.user.get_full_name|default:mechanic_data.mechanic.user.username }}</h5>
                            <p>Specialization: {{ mechanic_data.mechanic.specialization }}</p>
                            <p class="distance">{{ mechanic_data.distance }} km away</p>
                            <button type="button"
                                    class="btn btn-sm btn-primary mt-2 btn-select-mechanic"
                                    data-assign-url="{% url 'core:assign_mechanic' service_request.id mechanic_data.mechanic.id %}">
                                Select Mechanic
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary mt-2 ms-2 btn-view-details"
                                    data-mechanic-id="{{ mechanic_data.mechanic.id }}"
                                    data-details-url="{% url 'core:mechanic_details' mechanic_data.mechanic.id %}">
                                View Details
                            </button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No nearby mechanics found within 50 km radius.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <script id="nearby-mechanics-data" type="application/json">
        {{ mechanics_json|safe }}
    </script>
    <script id="nearby-places-data" type="application/json">
        {{ places_json|safe }}
    </script>
    <div class="text-center mt-4">
<a href="{% url 'core:service_request_detail' service_request.id %}" class="btn btn-secondary">Back to Request Details</a>
    </div>

    <!-- Mechanic Details Modal -->
    <div class="modal fade" id="mechanicDetailsModal" tabindex="-1" aria-labelledby="mechanicDetailsLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mechanicDetailsLabel">Mechanic Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="mechanicDetailsBody">
                    <div class="text-center py-3">Loading...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Mechanic Modal -->
    <div class="modal fade" id="confirmMechanicModal" tabindex="-1" aria-labelledby="confirmMechanicLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmMechanicLabel">Confirm Mechanic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmMechanicBody">
                    <div class="text-center py-3">Loading...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmMechanicButton">Confirm Mechanic</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    let serviceRequestMarker;
    let mechanicMarkers = [];
    let placeMarkers = []; // New array for nearby places markers
    let directionsService;
    let directionsRenderer;
    let infoWindow;
    let placesService; // New: Google Places Service

    function initMap() {
        const serviceLat = parseFloat("{{ service_request.latitude }}");
        const serviceLng = parseFloat("{{ service_request.longitude }}");
        const serviceLocation = { lat: serviceLat, lng: serviceLng };
        window.serviceLocation = serviceLocation;

        map = new google.maps.Map(document.getElementById("map"), {
            center: serviceLocation,
            zoom: 13,
        });

        infoWindow = new google.maps.InfoWindow();
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true
        });
        placesService = new google.maps.places.PlacesService(map); // Initialize Places Service

        // Marker for the service request location
        serviceRequestMarker = new google.maps.Marker({
            position: serviceLocation,
            map: map,
            title: 'Your Service Location',
            icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            }
        });

        serviceRequestMarker.addListener('click', () => {
            infoWindow.setContent('<strong>Your Service Location</strong><br>{{ service_request.location }}');
            infoWindow.open(map, serviceRequestMarker);
        });

        // Markers for nearby mechanics
        const nearbyMechanics = JSON.parse(document.getElementById('nearby-mechanics-data').textContent);
        displayMechanicMarkers(nearbyMechanics);

        // Markers for initially loaded nearby places (petrol bunks, automobile shops, towing services)
        const initialNearbyPlaces = JSON.parse(document.getElementById('nearby-places-data').textContent);
        displayPlaceMarkers(initialNearbyPlaces);

        // Fit map to bounds of all markers
        fitMapToBounds();
    }

    function displayMechanicMarkers(mechanics) {
        // Clear existing mechanic markers
        mechanicMarkers.forEach(marker => marker.setMap(null));
        mechanicMarkers = [];

        mechanics.forEach(mechanic => {
            const marker = new google.maps.Marker({
                position: { lat: mechanic.lat, lng: mechanic.lng },
                map: map,
                title: mechanic.name,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                }
            });

            marker.addListener('click', () => {
                infoWindow.setContent(`
                    <strong>${mechanic.name}</strong><br>
                    Specialization: ${mechanic.specialization}<br>
                    Distance: ${mechanic.distance} km
                `);
                infoWindow.open(map, marker);
            });
            mechanicMarkers.push(marker);
        });
    }

    function displayPlaceMarkers(places) {
        // Clear existing place markers
        placeMarkers.forEach(marker => marker.setMap(null));
        placeMarkers = [];

        places.forEach(place => {
            let iconUrl;
            if (place.type && (place.type.toLowerCase().includes('gas station') || place.type.toLowerCase().includes('petrol bunk'))) {
                iconUrl = "http://maps.google.com/mapfiles/ms/icons/green-dot.png";
            } else if (place.type && (place.type.toLowerCase().includes('car repair') || place.type.toLowerCase().includes('car dealer') || place.type.toLowerCase().includes('automobile shop'))) {
                iconUrl = "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
            } else if (place.type && place.type.toLowerCase().includes('towing service')) {
                iconUrl = "http://maps.google.com/mapfiles/ms/icons/ltblue-dot.png";
            } else {
                iconUrl = "http://maps.google.com/mapfiles/ms/icons/ltblue-dot.png"; // Default for other types
            }

            const marker = new google.maps.Marker({
                position: { lat: place.lat, lng: place.lng },
                map: map,
                title: place.name,
                icon: {
                    url: iconUrl
                }
            });

            marker.addListener('click', () => {
                infoWindow.setContent(`
                    <strong>${place.name}</strong><br>
                    Type: ${place.type}<br>
                    Rating: ${place.rating}<br>
                    Address: ${place.vicinity}
                `);
                infoWindow.open(map, marker);
            });
            placeMarkers.push(marker);
        });
    }

    function fitMapToBounds() {
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(serviceRequestMarker.getPosition());
        mechanicMarkers.forEach(marker => bounds.extend(marker.getPosition()));
        placeMarkers.forEach(marker => bounds.extend(marker.getPosition()));
        map.fitBounds(bounds);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // View Details modal wiring
        const detailsModalEl = document.getElementById('mechanicDetailsModal');
        const detailsModal = new bootstrap.Modal(detailsModalEl);
        const detailsTitle = document.getElementById('mechanicDetailsLabel');
        const detailsBody = document.getElementById('mechanicDetailsBody');

        // Confirm mechanic modal wiring
        const confirmModalEl = document.getElementById('confirmMechanicModal');
        const confirmModal = new bootstrap.Modal(confirmModalEl);
        const confirmBody = document.getElementById('confirmMechanicBody');
        const confirmButton = document.getElementById('confirmMechanicButton');

        function resetRoute() {
            if (directionsRenderer) {
                directionsRenderer.set('directions', null);
            }
            if (typeof fitMapToBounds === 'function') {
                fitMapToBounds();
            }
        }

        function renderDetails(data) {
            const avgRating = (data.average_rating || 0).toFixed(2);

            detailsBody.innerHTML = `
                <div class="mb-2">
                    <div class="d-flex align-items-center mb-1">
                        <h5 class="me-2 mb-0">${data.name}</h5>
                    </div>
                    <div class="text-muted">${data.specialization}</div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="p-2 border rounded">
                            <div class="text-uppercase small text-muted">Avg Rating</div>
                            <div><i class="fas fa-star text-warning"></i> ${avgRating} (${data.total_reviews} reviews)</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 border rounded">
                            <div class="text-uppercase small text-muted">Base Fee</div>
                            <div>â‚¹ ${data.base_fee.toFixed ? data.base_fee.toFixed(2) : data.base_fee}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 border rounded">
                            <div class="text-uppercase small text-muted">Experience</div>
                            <div>${data.experience_years} years</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-2 border rounded">
                            <div class="text-uppercase small text-muted">Language</div>
                            <div>${data.preferred_language?.toUpperCase?.() || data.preferred_language || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="text-uppercase small text-muted">Workshop Address</div>
                    <div>${data.workshop_address || 'N/A'}</div>
                </div>
            `;
        }

        document.querySelectorAll('.btn-view-details').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const url = this.dataset.detailsUrl;
                detailsTitle.textContent = 'Mechanic Details';
                detailsBody.innerHTML = '<div class="text-center py-3">Loading...</div>';
                detailsModal.show();
                fetch(url)
                    .then(r => {
                        if (!r.ok) throw new Error('Failed to load details');
                        return r.json();
                    })
                    .then(data => {
                        renderDetails(data);
                    })
                    .catch(err => {
                        console.error(err);
                        detailsBody.innerHTML = '<div class="text-danger">Failed to load mechanic details.</div>';
                    });
            });
        });

        // Handle Select Mechanic clicks: draw route + ask for confirmation
        document.querySelectorAll('.btn-select-mechanic').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();

                const card = this.closest('.mechanic-card');
                if (!card) return;

                const lat = parseFloat(card.dataset.lat);
                const lng = parseFloat(card.dataset.lng);
                const name = card.dataset.name;
                const distance = card.dataset.distance;
                const assignUrl = this.dataset.assignUrl;

                if (window.serviceLocation && directionsService && directionsRenderer) {
                    const request = {
                        origin: window.serviceLocation,
                        destination: { lat: lat, lng: lng },
                        travelMode: google.maps.TravelMode.DRIVING,
                    };

                    directionsService.route(request, (result, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            directionsRenderer.setDirections(result);
                        } else {
                            console.warn('Directions request failed:', status);
                        }
                    });
                }

                confirmBody.innerHTML = `
                    <p class="mb-2"><strong>Mechanic:</strong> ${name}</p>
                    <p class="mb-2"><strong>Approximate distance:</strong> ${distance} km</p>
                    <p class="text-muted mb-0">A route from your service location to this mechanic is highlighted on the map. Do you want to confirm this mechanic?</p>
                `;

                confirmButton.dataset.assignUrl = assignUrl;
                confirmModal.show();
            });
        });

        confirmButton.addEventListener('click', function() {
            const url = this.dataset.assignUrl;
            if (url) {
                window.location.href = url;
            }
        });

        confirmModalEl.addEventListener('hidden.bs.modal', function () {
            resetRoute();
        });

        // Handle clicks on mechanic cards to center map on their location
        document.querySelectorAll('.mechanic-card').forEach(card => {
            card.addEventListener('click', function() {
                const lat = parseFloat(this.dataset.lat);
                const lng = parseFloat(this.dataset.lng);
                const name = this.dataset.name;
                const specialization = this.dataset.specialization;
                const distance = this.dataset.distance;

                map.setCenter({ lat: lat, lng: lng });
                map.setZoom(15); // Zoom in on the selected mechanic

                // Open info window for the selected mechanic
                infoWindow.setContent(`
                    <strong>${name}</strong><br>
                    Specialization: ${specialization}<br>
                    Distance: ${distance} km
                `);
                const selectedMarker = mechanicMarkers.find(marker => 
                    marker.getPosition().lat() === lat && marker.getPosition().lng() === lng
                );
                if (selectedMarker) {
                    infoWindow.open(map, selectedMarker);
                }
            });
        });

        // Handle place search
        const placeSearchInput = document.getElementById('place-search-input');
        const searchPlacesButton = document.getElementById('search-places-button');

        searchPlacesButton.addEventListener('click', performPlaceSearch);
        placeSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performPlaceSearch();
            }
        });

        function performPlaceSearch() {
            const query = placeSearchInput.value;
            if (!query) return;

            const serviceLat = parseFloat("{{ service_request.latitude }}");
            const serviceLng = parseFloat("{{ service_request.longitude }}");
            const serviceLocation = new google.maps.LatLng(serviceLat, serviceLng);

            const request = {
                location: serviceLocation,
                radius: '50000', // 50 km radius
                query: query
            };

            placesService.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    const newPlaces = results.map(place => ({
                        name: place.name,
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng(),
                        type: place.types.join(', ').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        rating: place.rating || 'N/A',
                        vicinity: place.vicinity || place.formatted_address
                    }));
                    displayPlaceMarkers(newPlaces);
                    fitMapToBounds();
                } else {
                    console.error('Places search failed:', status);
                    showStatus('Could not find any places for your search.', 'warning');
                }
            });
        }
    });
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMap" async defer></script>
{% endblock %}
