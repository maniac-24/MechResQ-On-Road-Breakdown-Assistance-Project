<!DOCTYPE html>
<html>
  <head>
    <title>MechResQ Custom Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      let map;
      let userLocationMarker;
      let placesService;
      let infoWindow;

      function initMap() {
        infoWindow = new google.maps.InfoWindow();

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: userLocation,
                styles: [
                  {
                    "elementType": "geometry",
                    "stylers": [{ "color": "#242f3e" }]
                  },
                  {
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#746855" }]
                  },
                  {
                    "elementType": "labels.text.stroke",
                    "stylers": [{ "color": "#242f3e" }]
                  },
                  {
                    "featureType": "administrative.locality",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#d59563" }]
                  },
                  {
                    "featureType": "poi",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#d59563" }]
                  },
                  {
                    "featureType": "poi.park",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#263c3f" }]
                  },
                  {
                    "featureType": "poi.park",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#6b9a76" }]
                  },
                  {
                    "featureType": "road",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#38414e" }]
                  },
                  {
                    "elementType": "road",
                    "elementType": "geometry.stroke",
                    "stylers": [{ "color": "#212a37" }]
                  },
                  {
                    "featureType": "road",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#9ca5b3" }]
                  },
                  {
                    "featureType": "road.highway",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#746855" }]
                  },
                  {
                    "featureType": "road.highway",
                    "elementType": "geometry.stroke",
                    "stylers": [{ "color": "#1f2835" }]
                  },
                  {
                    "featureType": "road.highway",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#f3d19c" }]
                  },
                  {
                    "featureType": "transit",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#2f3948" }]
                  },
                  {
                    "featureType": "transit.station",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#d59563" }]
                  },
                  {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#17263c" }]
                  },
                  {
                    "featureType": "water",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "color": "#515c6d" }]
                  },
                  {
                    "featureType": "water",
                    "elementType": "labels.text.stroke",
                    "stylers": [{ "color": "#17263c" }]
                  }
                ]
              });

              userLocationMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                  url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                }
              });

              placesService = new google.maps.places.PlacesService(map);
              searchNearbyServices(userLocation);
            },
            () => {
              handleLocationError(true, infoWindow, map.getCenter());
            }
          );
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
          browserHasGeolocation
            ? "Error: The Geolocation service failed."
            : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
      }

      function searchNearbyServices(location) {
        const serviceTypes = [
          'car_repair', 'gas_station', 'car_wash', 'car_dealer', 'car_rental', 'mechanic', 'towing_service'
        ];

        serviceTypes.forEach(type => {
          const request = {
            location: location,
            radius: '5000', // 5 km radius
            type: type,
          };

          placesService.nearbySearch(request, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
              for (let i = 0; i < results.length; i++) {
                createMarker(results[i]);
              }
            }
          });
        });
      }

      function createMarker(place) {
        if (!place.geometry || !place.geometry.location) return;

        const marker = new google.maps.Marker({
          map,
          position: place.geometry.location,
          title: place.name,
        });

        google.maps.event.addListener(marker, "click", () => {
          infoWindow.setContent(place.name || "");
          infoWindow.open(map, marker);
        });
      }
    </script>

    <script async
      src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap&libraries=places">
    </script>
  </body>
</html>
