{% extends 'base_mechanic.html' %}
{% load static %}

{% block title %}Earnings - Mechanic Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/earnings.css' %}">
{% endblock %}

{% block main_content %}
<div class="earnings-container">
    <!-- Earnings Summary -->
    <div class="earnings-card">
        <div class="earnings-summary">
            <div class="summary-card total">
                <h3>Total Earnings</h3>
                <div class="amount">₹{{ total_earnings|floatformat:2 }}</div>
                <div class="trend">+{{ earnings_growth }}% from last month</div>
            </div>
            <div class="summary-card">
                <h3>This Month</h3>
                <div class="amount">₹{{ monthly_earnings|floatformat:2 }}</div>
                <div class="trend">{{ completed_services }} services completed</div>
            </div>
            <div class="summary-card pending">
                <h3>Pending Payments</h3>
                <div class="amount">₹{{ pending_amount|floatformat:2 }}</div>
                <div class="trend">{{ pending_services }} services pending</div>
            </div>
        </div>

        <!-- Earnings Chart -->
        <div class="chart-container">
            <canvas id="earningsChart"></canvas>
        </div>
    </div>

    <!-- Payment History -->
    <div class="earnings-card earnings-history">
        <div class="history-header">
            <h2 class="history-title">Payment History</h2>
            <div class="history-filters">
                <select id="monthFilter" class="form-select">
                    <option value="all">All Time</option>
                    <option value="1">Last Month</option>
                    <option value="3">Last 3 Months</option>
                    <option value="6">Last 6 Months</option>
                </select>
            </div>
        </div>

        <div class="table-responsive">
            <table class="payment-table">
                <thead>
                    <tr>
                        <th>Service ID</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Your Share</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr>
                        <td>#{{ payment.service_request.id }}</td>
                        <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                        <td>{{ payment.service_request.user.get_full_name }}</td>
                        <td>₹{{ payment.total_amount|floatformat:2 }}</td>
                        <td>₹{{ payment.mechanic_share|floatformat:2 }}</td>
                        <td>
                            <span class="status-badge status-{{ payment.payment_status|lower }}">
                                {{ payment.payment_status }}
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">No payments found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('earningsChart').getContext('2d');
    const earningsData = JSON.parse('{{ earnings_data|escapejs }}');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: earningsData.labels,
            datasets: [{
                label: 'Monthly Earnings',
                data: earningsData.values,
                borderColor: 'var(--primary-color)',
                backgroundColor: 'rgba(0, 123, 255, 0.1)', /* Using a direct rgba for chart fill */
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: "var(--background-medium)",
                    titleColor: 'var(--text-light)',
                    bodyColor: 'var(--text-dark)',
                    borderColor: 'var(--border-color)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        color: 'var(--border-color)'
                    },
                    ticks: {
                        color: 'var(--text-dark)',
                        callback: function(value) {
                            return '₹' + value;
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'var(--text-dark)'
                    }
                }
            }
        }
    });

    // Handle payment history filtering
    document.getElementById('monthFilter').addEventListener('change', function(e) {
        const months = e.target.value;
        window.location.href = `/earnings/?months=${months}`;
    });
});
</script>
{% endblock extra_js %}
