{% extends 'base.html' %}
{% load static %}
{% block title %}Mechanic Dashboard - Vehicle Breakdown Service{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mechanic-dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <main class="main-content">
        <div class="dashboard-header">
            <div class="welcome-section">
                    <div class="welcome-text">
                        <h1>Welcome back, {{ request.user.get_full_name }}</h1>
                        <p>Here's what's happening with your service requests today</p>
                        <div id="mechanicTrackingStatus" class="mt-3"></div>
                    </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">Total Services</span>
                        <div class="stat-icon" style="color: var(--primary-color);">
                            <i class="fas fa-tools"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ total_services }}</div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>12% vs last month</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">Completed Services</span>
                        <div class="stat-icon" style="color: #047857;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ completed_services }}</div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>8% vs last month</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">In Progress</span>
                        <div class="stat-icon" style="color: #c2410c;">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ in_progress_services }}</div>
                    <div class="stat-trend trend-down">
                        <i class="fas fa-arrow-down"></i>
                        <span>3% vs last month</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-title">Total Earnings</span>
                        <div class="stat-icon" style="color: #16a34a;">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="stat-value">${{ total_earnings }}</div>
                    <div class="stat-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>15% vs last month</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-card mb-4">
                    <div class="chart-header">
                        <h6 class="m-0 font-weight-bold" style="color: var(--text-light);">Service Performance</h6>
                        <div class="chart-period-selector">
                            <select class="form-select form-select-sm" id="chartPeriod">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 3 Months</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="height: 350px;">
                            <canvas id="serviceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="service-requests">
                    <div class="request-header">
                        <h3 class="chart-title">Recent Requests</h3>
                    </div>
                    <div class="request-list">
                        {% for service_request in service_requests|slice:":5" %}
                        <a href="{% url 'core:service_request_detail' pk=service_request.pk %}" class="request-item">
                            <div class="request-info">
                                <div class="request-details">
                                    <h4>{{ service_request.vehicle_type }} Service</h4>
                                    <p>{{ service_request.location }}</p>
                                </div>
                                <span class="request-status {% if service_request.status == 'PENDING' %}status-pending{% else %}status-progress{% endif %}">
                                    {{ service_request.status }}
                                </span>
                            </div>
                        </a>
                        {% empty %}
                        <div class="text-center py-4" style="color: var(--text-dark);">
                            No recent service requests
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="service-requests mt-4">
                    <div class="request-header">
                        <h3 class="chart-title">Emergency Requests</h3>
                    </div>
                    <div class="request-list">
                        {% for emergency_request in emergency_requests|slice:":5" %}
                        <div class="request-item">
                            <div class="request-info">
                                <div class="request-details">
                                    <h4>Emergency from {{ emergency_request.user.username }}</h4>
                                    <p>Location: {{ emergency_request.latitude }}, {{ emergency_request.longitude }}</p>
                                    <p>Status: {{ emergency_request.status }}</p>
                                </div>
                                {% if emergency_request.status == 'PENDING' %}
                                <button class="btn btn-sm btn-danger" onclick="acceptEmergencyRequest('{{ emergency_request.id }}')">Accept SOS</button>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4" style="color: var(--text-dark);">
                            No emergency requests
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="service-requests mt-4">
                    <div class="request-header">
                        <h3 class="chart-title">Cash Payments to Confirm</h3>
                    </div>
                    <div class="request-list">
                        {% for service_request in cash_payment_requests %}
                            <div class="request-item d-flex justify-content-between align-items-center">
                                <div class="request-details">
                                    <h4>Cash Payment for #{{ service_request.id }}</h4>
                                    <p>Customer: {{ service_request.user.get_full_name }}</p>
                                    <p>Amount: â‚¹{{ service_request.payment.total_amount }}</p>
                                </div>
                                <form method="POST" action="{% url 'core:confirm_cash_payment' service_request.payment.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="fas fa-check-circle me-1"></i> Confirm Cash Payment
                                    </button>
                                </form>
                            </div>
                        {% empty %}
                        <div class="text-center py-4" style="color: var(--text-dark);">
                            No pending cash payments to confirm.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Service Performance Chart
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('serviceChart').getContext('2d');
        const serviceTrendData = JSON.parse('{{ service_trend|escapejs }}');
        let chart;

        function createGradient(ctx) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(78, 115, 223, 0.2)');
            gradient.addColorStop(1, 'rgba(78, 115, 223, 0.0)');
            return gradient;
        }

        function initChart(data, labels) {
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Services',
                        data: data,
                        lineTension: 0.4,
                        backgroundColor: createGradient(ctx),
                        borderColor: "rgba(78, 115, 223, 1)",
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: "#ffffff",
                        pointBorderColor: "rgba(78, 115, 223, 1)",
                        pointBorderWidth: 2,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: "rgba(78, 115, 223, 1)",
                        pointHoverBorderColor: "#ffffff",
                        pointHoverBorderWidth: 2,
                        pointHitRadius: 10,
                        fill: true
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            left: 10,
                            right: 25,
                            top: 25,
                            bottom: 0
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                maxTicksLimit: 7,
                                padding: 10,
                                color: '#64748b',
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif",
                                    weight: '500'
                                }
                            }
                        },
                        y: {
                            ticks: {
                                maxTicksLimit: 5,
                                padding: 10,
                                color: '#64748b',
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif",
                                    weight: '500'
                                },
                                callback: function(value) {
                                    return value + ' services';
                                }
                            },
                            grid: {
                                color: "rgba(234, 236, 244, 0.8)",
                                borderDash: [5],
                                drawBorder: false,
                                zeroLineColor: "rgba(234, 236, 244, 1)",
                                zeroLineBorderDash: [5]
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: "rgba(255, 255, 255, 0.95)",
                            titleColor: '#1e293b',
                            titleFont: {
                                size: 14,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            bodyColor: '#64748b',
                            bodyFont: {
                                size: 13,
                                family: "'Inter', sans-serif"
                            },
                            borderColor: 'rgba(220, 220, 220, 0.6)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            intersect: false,
                            mode: 'index',
                            caretPadding: 8,
                            cornerRadius: 8,
                            callbacks: {
                                title: function(context) {
                                    return 'Date: ' + context[0].label;
                                },
                                label: function(context) {
                                    return 'Services: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // Initialize with all data
        const labels = serviceTrendData.map(item => {
            const date = new Date(item.day);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const data = serviceTrendData.map(item => item.count);
        initChart(data, labels);

        // Handle period changes
        document.getElementById('chartPeriod').addEventListener('change', function(e) {
            const days = parseInt(e.target.value);
            const filteredData = serviceTrendData.slice(-days);
            const newLabels = filteredData.map(item => {
                const date = new Date(item.day);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const newData = filteredData.map(item => item.count);
            initChart(newData, newLabels);
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (chart) {
                chart.resize();
            }
        });
    });

    // Function to accept emergency request
    function acceptEmergencyRequest(emergencyRequestId) {
        if (confirm('Are you sure you want to accept this emergency request?')) {
            fetch(`/api/emergency/${emergencyRequestId}/accept/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error accepting emergency request: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while accepting the emergency request.');
            });
        }
    }

    // Mechanic Location Tracking (Firebase Realtime Database)
    const activeMechanicServiceRequestScript = document.getElementById('active_mechanic_service_request_data');
    let activeMechanicServiceRequest = null;
    if (activeMechanicServiceRequestScript) {
        try {
            activeMechanicServiceRequest = JSON.parse(activeMechanicServiceRequestScript.textContent);
        } catch (e) {
            console.error("Error parsing active_mechanic_service_request_data:", e);
        }
    }

    let firebaseDatabase; // Firebase Realtime Database instance
    let watchId; // To store the ID of the geolocation watchPosition

    // Initialize Firebase Realtime Database if config is available
    if (firebase && firebase.database) {
        firebaseDatabase = firebase.database();
    } else {
        console.error("Firebase Realtime Database not initialized. Check Firebase SDK loading in base.html.");
    }

    // Start continuous location tracking if there's an active service request
    if (activeMechanicServiceRequest && firebaseDatabase) {
        startMechanicLocationTracking(activeMechanicServiceRequest.mechanic_id);
    } else {
        const statusDiv = document.getElementById('mechanicTrackingStatus');
        if (statusDiv) {
            statusDiv.innerHTML = '<span class="text-muted"><i class="fas fa-info-circle me-1"></i> No active service request for live tracking.</span>';
        }
    }

    /**
     * Starts continuous geolocation tracking and updates Firebase Realtime Database.
     * @param {number} mechanicId - The ID of the mechanic whose location is being tracked.
     */
    function startMechanicLocationTracking(mechanicId) {
        const statusDiv = document.getElementById('mechanicTrackingStatus');
        if (!navigator.geolocation) {
            if (statusDiv) statusDiv.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i> Geolocation is not supported by your browser.</span>';
            console.error("Geolocation is not supported by this browser.");
            return;
        }

        if (statusDiv) statusDiv.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i> Starting live location tracking...</span>';

        // Watch the mechanic's position continuously
        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // Path in Firebase Realtime Database to update mechanic's location
                const mechanicLocationRef = firebaseDatabase.ref(`mechanic_locations/${mechanicId}`);
                
                // Update Firebase with the new location
                mechanicLocationRef.set({
                    latitude: latitude,
                    longitude: longitude,
                    timestamp: new Date().toISOString()
                })
                .then(() => {
                    if (statusDiv) statusDiv.innerHTML = `<span class="text-success"><i class="fas fa-map-marker-alt me-1"></i> Location updated: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}</span>`;
                    console.log(`Mechanic ${mechanicId} location updated to Firebase: ${latitude}, ${longitude}`);
                })
                .catch((error) => {
                    if (statusDiv) statusDiv.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i> Error updating location to Firebase.</span>';
                    console.error("Error writing mechanic location to Firebase:", error);
                });

                // Also send to Django backend for database persistence (LocationHistory and ServiceRequest updates)
                sendLocationToDjango(latitude, longitude);
            },
            (error) => {
                if (statusDiv) statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle me-1"></i> Error tracking location: ${error.message}</span>`;
                console.error("Error watching mechanic location:", error);
            },
            {
                enableHighAccuracy: true, // Request high accuracy
                maximumAge: 0, // No cached position
                timeout: 5000 // 5 seconds timeout
            }
        );
    }

    /**
     * Sends the mechanic's current location to the Django backend for persistence.
     * This updates the Mechanic model and active ServiceRequest models.
     * @param {number} latitude - The current latitude.
     * @param {number} longitude - The current longitude.
     */
    function sendLocationToDjango(latitude, longitude) {
        fetch('{% url "core:update_mechanic_location" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                latitude: latitude,
                longitude: longitude
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Error updating location to Django backend: ' + data.error);
            }
        })
        .catch(error => {
            console.error('An error occurred while updating location to Django backend:', error);
        });
    }

    // Optional: Stop tracking when the mechanic navigates away or logs out
    // window.addEventListener('beforeunload', () => {
    //     if (watchId) {
    //         navigator.geolocation.clearWatch(watchId);
    //         console.log("Mechanic location tracking stopped.");
    //     }
    // });
</script>
{% endblock %}
